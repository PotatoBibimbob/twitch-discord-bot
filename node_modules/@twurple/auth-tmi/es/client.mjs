import { getValidTokenFromProvider, InvalidTokenTypeError } from '@twurple/auth';
import { Client as BaseClient } from 'tmi.js';
/**
 * An extension of the tmi.js client which extends it with {@AuthProvider} integration.
 */
export class DecoratedClient extends BaseClient {
    /**
     * Creates a new tmi.js client which utilizes the given {@AuthProvider} instance.
     *
     * @param opts The tmi.js options, with the auth provider replacing the identity option.
     */
    constructor(opts) {
        const { authProvider, ...tmiOpts } = opts;
        super({
            ...tmiOpts,
            identity: {
                // need this because we can't get a user name dynamically, but need something to not default to justinfan
                username: 'dummy',
                password: async () => {
                    if (authProvider.tokenType === 'app') {
                        throw new InvalidTokenTypeError(`You can not connect to chat using an AuthProvider that supplies app access tokens.
Please provide an auth provider that provides user access tokens, such as \`RefreshingAuthProvider\`.`);
                    }
                    const { accessToken } = await getValidTokenFromProvider(authProvider, ['chat:read', 'chat:edit']);
                    return accessToken.accessToken;
                }
            }
        });
    }
}
export const Client = DecoratedClient;
